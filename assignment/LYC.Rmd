---
title: "Title of your report"
author: "Leave author name blank"
date: "Your submission date"
output:
  pdf_document: 
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### R Packages

```{r warning=FALSE,message=FALSE}
require(lme4)
require(lmerTest)
require(ggplot2)
require(sjPlot)
```

#### Data

```{r}
MST <- read.csv("https://andygolightly.github.io/teaching/MATH43515/summative/andy.csv",  
                header=TRUE)
#MST<- read.csv("andy.csv", header=TRUE) #Use this if the file is saved locally
head(MST)
dim(MST)
```

We see that the data set possesses 200 rows and 9 columns. These columns represent the following variables:

-   `ID`: anonymized nurse identifer;
-   `Hospital`: hospital identifier $\{1,2,\ldots,20\}$;\
-   `Trt`: treatment / experiment indicator (0=control; 1=training program given (treatment));
-   `Experience`: nurse experience (continuous scale, units of years);
-   `Gender`: gender indicator (0=male; 1=female);
-   `Size`: indicator of A&E department size (0=small, 1=large);
-   `Responset1`: A post-test stress score for each nurse at time 1;
-   `Responset2`: A post-test stress score for each nurse at follow-up time 2;
-   `Responset3`: A post-test stress score for each nurse at follow-up time 3;

## Introduction (20 marks)

### multisite trials

Give some background on multisite trials, and their relevance for assessing the effectiveness of an intervention.

Multi-centre trials are clinical trials conducted simultaneously in multiple geographical locations. These trials involve recruiting participants from different locations, which can be hospitals, clinics, research centres or community settings. The main objectives of multicentre trials are to assess the effectiveness, safety and sometimes cost-effectiveness of interventions and their application in different and representative populations.

### Data visualisation

Before starting the analysis, the relationship between extraversion and popularity can be plotted, regardless of the multilevel structure of the data.

```{r}
ggplot(data  = MST,
       aes(x = Trt,
           y = Responset1))+
  geom_point(size     = 1.2,
             alpha    = .8,
             position = "jitter")+ #to add some random noise for plotting purposes
  geom_smooth(method = lm,
              se     = FALSE, 
              col    = "black",
              size   = .5, 
              alpha  = .8)+ # to add regression line
  theme_minimal()+
  labs(title    = "Trt vs. Responset1",
       subtitle = "add regression line")
```

This multi-level structure can be displayed by colour coding the different hospitals.

```{r}
ggplot(data    = MST,
       aes(x   = Trt,
           y   = Responset1,
           col = Hospital))+ #to add the colours for different classes
  geom_point(size     = 1.2,
             alpha    = .8,
             position = "jitter")+ #to add some random noise for plotting purposes
  theme_minimal()+
  theme(legend.position = "none")+
  scale_color_gradientn(colours = rainbow(20))+
  labs(title    = "Trt vs. Responset1",
       subtitle = "add colours for different Hospital")
```

Now we can plot different regression lines for the 20 different Hospitals in the data

```{R}
ggplot(data      = MST,
       aes(x     = Trt,
           y     = Responset1,
           col   = Hospital,
           group = Hospital))+ #to add the colours for different classes
  geom_point(size     = 1.2,
             alpha    = .8,
             position = "jitter")+ #to add some random noise for plotting purposes
  theme_minimal()+
  theme(legend.position = "none")+
  scale_color_gradientn(colours = rainbow(20))+
  geom_smooth(method = lm,
              se     = FALSE,
              size   = .5, 
              alpha  = .8)+ # to add regression line
  labs(title    = "Trt vs. Responset1",
       subtitle = "add colours for different Hospital and regression lines")
```

The above visualisation shows that there is a linear relationship between intervention (Trt) and Responset1

## Methods (20 marks)

A multilevel model is a statistical model used to analyse nested or hierarchical data. This model is well suited to this dataset because the data have a distinct hierarchical structure: nurses are nested within hospitals, and each nurse repeatedly measures stress scores at different points in time.

The main role of multilevel modelling is to deal appropriately with dependencies and non-independence in nested data. In this example, the measurements of nurses in the same hospital and the same nurse at different points in time may be correlated rather than completely independent. Multilevel modelling can explicitly model and estimate this dependence. The overall variance is decomposed into variance components at different levels. By estimating the random effects variance at each level, we can understand what proportion of the total variance is accounted for by the variance at the hospital level, the individual nurse level, and the residual level. This helps to determine which level of variance is most significant. Both fixed and random effects were estimated. Fixed effects are systematic effects that affect the entire population, while random effects are specific to each cluster or individual.

The report begins with a three-level linear mixed-effects model, with the first level being the time level (repeated measures), the second level being the individual nurse level, and the third level being the hospital level, which takes into account fixed-effects interventions, time, experience, gender, and unit size, as well as random effects, where there is a random intercept at the hospital level (to capture between-hospital variance), and a random intercept at the nurse level (to capture between-individual nurse differences). To estimate the variance components at each level in the model's pooled output, see the "Random Effects" section, which gives estimates of the variance of the random effects at each level. icc = between-cohort variance/(between-cohort variance + residual variance)

## Analysis (35 marks)

In order to verify whether the experimental "intervention" had a significant effect on nurse stress and how this effect evolved over time, the data set was converted to a long format, where each row represents a nurse's observation at a certain point in time. Prior to modelling, the dataset was first converted to a long format, where each row represents the observations of a nurse at a given point in time, and a new variable Time was created, corresponding to the test time points (1,2,3). The Response variables (Responset1, Responset2, Responset3) are combined into a new variable named Stress.

```{r}
library(reshape2)
dat_long <- melt(MST, id.vars=c("ID","Hospital","Trt","Experience","Gender","Size"), 
                 variable.name="Time", value.name="Stress")

# Refactoring the Time variable 
dat_long$Time <- as.numeric(sub("^Responset", "", dat_long$Time))


```

### Three level Model with explanatory variables

The following three-level nested linear mixed-effects model was developed for the nurse work stress data.

Let $y_{ijk}$ denote the job stress score of the $j$ nurse in the $k$ hospital at time $i$, the model can be expressed as follows.

$$y_{ijk} = \gamma_0 + \alpha_i + \beta_j + \gamma_k + \epsilon_{ijk}$$

-   $\gamma_0$ is the overall mean stress score - $\alpha_i$ is the fixed effect of time $i$, i.e., systematic differences in stress scores at different time points - \$$\beta_j \ sim N(0, \sigma^2_\beta)$ is a random effect for the $j$th nurse, capturing individual differences across nurses

-   $\gamma_k \sim N(0, \sigma^2_\gamma)$ is a random effect for the $k$th hospital, capturing cluster effects across hospitals - $\epsilon_{ijk} \sim N(0, \sigma^2)$ is the residual random error term.

In this linear mixed-effects model, ID was considered as a random-effects term used to control for the correlation of repeated measures; for the same nurse, his/her work stress scores measured at different points in time are likely to be correlated rather than completely independent. Setting ID as a random-effects term can solve this problem of correlation of repeated-measures data.

```{r}
model.1 <- lmer(Stress ~ Trt * Time + Experience + Gender + Size + (1|Hospital/ID), data=dat_long)
summary(model.1)

```

The above can be concluded:

The main effect of intervention (Trt) was significantly negative (estimate -5.24, p\<2e-16), indicating that nurses in the experimental group who received the training programme had significantly lower job stress scores than the control group.

The main effect of Time was not significant (p=0.111702), but the interaction term between Time and Intervention (Trt:Time) was significantly positive (estimate 0.86, p\<0.001), indicating that the effect of the training programme on alleviating work stress increased over time.

The effect of experience is significantly negative (estimated value -0.09, p\<0.001), which means that the longer the years of working experience, the lower the job stress.

The effect of gender was significantly positive (estimated value 1.52, p\<0.001), and the work pressure of female nurses was significantly higher than that of males.

The effect of unit size was significantly positive (estimated value 2.52, p\<0.01), and nurses in large units had significantly higher work stress than those in small units.

The random effects of the model showed that the effects of both hospital and individual level variation on work stress were significantly not equal to zero, indicating that the inclusion of hospital and individual as random effect terms was justified.

The standard deviation of the residuals was 1.87, and the standard deviations of the random effects for the hospital and individual levels were 1.41 and 1.00, respectively, indicating that the contributions of these three sources of variation were comparable.

We can then extract the estimated variance components from the model via:

```{r}
REsummary <- as.data.frame(VarCorr(model.1))
REsummary
```

**VPC and ICC values.** 1. VPC estimates

```{r}
sig <- REsummary$vcov[3]  #Residual variance
sigv <- REsummary$vcov[2] #RE variance for Hospital
sigu <- REsummary$vcov[1] #RE variance for ID:Hospital
totalvar <- sum(REsummary$vcov) #total variance
vpc.Hospital <- sigv/totalvar 

vpc.ID <- sigu/totalvar 
vpc.Hospital
vpc.ID
```

vpc represents the proportion of the variance component of each level to the total variance (Variance Partition Coefficient). vpc.Hospital = 0.3065233, indicating that the variance at the hospital level accounted for 30.65 per cent of the total variance, which is a considerable proportion. This implies that there is significant heterogeneity or difference between hospitals, which is an important source of variation in the level of job stress. vpc.ID = 0.154939, which indicates that the variance at the individual nurse level accounts for 15.49% of the total variance. Although the proportion is not as high as that at the hospital level, it does indicate that there is some variation across individuals. Combining the two vpc values, we can see that the influence of heterogeneity is greater at the hospital level, which is the main source of the variance in work stress, accounting for 30.65%. The effect of individual differences is relatively small

2.  ICC estimates

```{r}
icc.Hospital <- sigv/totalvar 

icc.ID <- (sigu+sigv)/totalvar 
 
icc.Hospital
icc.ID
```

The ICC at the individual nurse level was 0.4614623, and the ICC at the hospital level was 0.3065233. Usually, the larger the ICC value, the stronger the correlation between the observations within the same group, and the higher the necessity of adopting multilevel modelling. The individual nurse level ICC was 0.4614623, indicating a high positive correlation (46.15 per cent) between job stress scores of the same nurse at different time points. This confirms the necessity of nesting the time dimension within the individual nurse dimension, which would otherwise violate the assumption of observational independence. The hospital-level ICC of 0.3065233 indicated that there was also some degree of positive correlation (30.65%) between job stress scores of different nurses within the same hospital. This reflects the clustering effect of hospitals and indicates heterogeneity among different hospitals. Both ICC values are quite high and close to each other, suggesting that the variation in work stress comes from both hospital differences and individual differences, both of which are significant and cannot be ignored at either level.

**Taking these results together, the following questions will be responded to next.**

1.  What is the intervention effect and its confidence interval estimate; is the intervention effect significant? In this linear mixed model, the intervention effect refers to the effect of the training programme (Trt) on nurses' job stress.The estimated value of Trt was -5.23857, indicating that nurses in the experimental group who received the training scored, on average, 5.24 points lower on their job stress scores than those in the control group (after controlling for the effects of the other variables).The main effect of the treatment/intervention condition of Trt (p\<2e-16) was significant, indicating that nurses in the experimental group who received the training had significantly lower job stress scores than those in the control group. indicating that nurses in the experimental group who received training were significantly less stressed at work than those in the control group. Assuming a 95% confidence level, which corresponds to a degree of freedom of 572.47, and a two-sided critical value of approximately ±1.96, the 95% confidence interval for the Trt effect is: Estimate ± 1.96 \* Standard Error = -5.23857 ± 1.96 \* 0.43560 = (-6.09, -4.39). In other words, the confidence interval for the reduction effect of training programmes on job stress is about (4.39, 6.09) points at the 95% confidence level. This confidence interval does not contain zero, which further validates the existence of a significant negative effect of the intervention, i.e., the training did help to significantly reduce nurses' job stress.

2.  Is there evidence of heterogeneity of the intervention effect between hospitals? The hospital-level ICC of 0.3065233 indicates that there is also some degree of positive correlation (30.65 per cent) between job stress scores of different nurses within the same hospital. This reflects the cluster effect of hospitals, indicating heterogeneity among different hospitals.

3.  Is there evidence of a change of the intervention effect over time? The main effect of time (Time) was not significant (p=0.111702), but the interaction term between time and intervention (Trt:Time) was significantly positive (estimate 0.86, p\<0.001), suggesting that the effect of the training programme on relieving work stress increased over time.

4.  What other covariates are important in explaining stress? Trt (p\<2e-16) The main effect of treatment/intervention condition was significant, indicating that nurses in the experimental group who received training were significantly less stressed than those in the control group. Experience (p=0.000925) The effect of work experience was significantly negative, i.e., the more years of work experience, the lower the work stress. Gender (p=1.98e-10) The effect of gender was significant, as female nurses had significantly higher job stress than males. Size (p=0.001983) There was a significant effect of the size of the unit, and the work stress of nurses in large units was significantly higher than that of nurses in small units. Trt:Time (p=5.58e-06) The interaction term between treatment and time was significant, indicating that the intervention effect increased over time. Null variables (non-significant effects). Time (p=0.111702) The main effect of time was not significant, i.e., stress scores did not differ significantly between time points. Therefore, based on the level of significance, we can consider the variables Trt, Experience, Gender, Size, and Trt:Time as significant variables in this model that effectively explain job stress, while the main effect of Time is null.

5.  For the final fitted model(s), are the model assumptions reasonable?

-   Residual normality assumption

```{r}
# Q-Q
qqnorm(resid(model.1))
qqline(resid(model.1))  

# histogram of residuals
hist(resid(model.1))
```

If the residuals in the Q-Q plot basically fall on a straight line and the histogram is close to a bell shape, the residuals can be regarded as approximately obeying a normal distribution.

-   Cascade effects normality assumption

```{r}
# Residual vs fitted value plot
plot(fitted(model.1), resid(model.1))
abline(h=0, lty=2)

# Residual vs Explanatory Variable Plot (in Trt)
plot(dat_long$Trt, resid(model.1))
```

There is no clear pattern of heteroskedasticity in the residuals at different fitted values or levels of explanatory variables, and the assumption of homoskedasticity is satisfied.

The model's assumptions are therefore reasonable

## Discussion of results (15 marks)

The above sections have demonstrated that these data provide evidence of the effectiveness of the intervention.Overall, there are three levels of variation in work stress: time, individual and hospital. Variation at the time level is nested in the individual level, and the individual level is nested in the hospital level. In analysing and interpreting the effects of work stress, much attention needs to be paid to hospital-level effects, and targeted interventions need to be implemented to reduce inter-hospital variability. Variation in work stress comes from both hospital differences and individual differences, and the effects of both are significant enough that neither level can be ignored. Three-level nested models are more complex compared to simple models and require more computational resources and time to estimate the parameters. In addition, the complexity of the model increases the difficulty in interpreting the model results. Based on the given dataset variables, in addition to the covariates of experience, gender, and department size, which are already included in the model, age, education, etc., can also be considered.

------------------------------------------------------------------------

## Word count

```{r}
#install.packages("devtools")
#devtools::install_github("benmarwick/wordcountaddin", type = "source", dependencies = TRUE)
require(wordcountaddin)
word_count()
text_stats()
```
